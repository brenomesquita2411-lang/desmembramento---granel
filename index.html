<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Desmembramento de Granel - Mobile</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: #e9ecef;
    padding: 16px;
    color: #222;
}
h1 {
    text-align: center;
    color: #004d36;
    margin-bottom: 16px;
    font-size: 20px;
}
.container {
    background: #fff;
    padding: 16px;
    border-radius: 12px;
    max-width: 500px;
    margin: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
label {
    display: block;
    margin-top: 12px;
    font-size: 14px;
}
input {
    width: 100%;
    padding: 14px;
    margin-top: 6px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #bbb;
    box-sizing: border-box;
}
button {
    width: 100%;
    padding: 14px;
    margin-top: 16px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    background: #006e4a;
    color: #fff;
    cursor: pointer;
}
button:hover { background: #00563a; }
button.secondary { background: #888; }
#resultado {
    margin-top: 20px;
    padding: 16px;
    background: #f1f8f4;
    border-left: 6px solid #006e4a;
    border-radius: 8px;
    white-space: pre-wrap;
    font-size: 14px;
}
.progress-bar {
    width: 100%;
    background: #ddd;
    border-radius: 8px;
    margin-top: 8px;
    height: 20px;
    overflow: hidden;
}
.progress-fill { height: 100%; background: #006e4a; width: 0%; transition: width 0.3s; }
.alert-verde { color: #006e4a; }
.alert-amarelo { color: #b38f00; }
.alert-vermelho { color: #c00000; }
</style>
</head>
<body>

<h1>Desmembramento de Granel</h1>

<div class="container">

<label>Quantidade de barricas:</label>
<input type="number" id="qtdBarricas" min="1">
<button type="button" onclick="gerarBarricas()">Gerar campos</button>
<div id="barricas"></div>

<label>Peso médio do comprimido (g):</label>
<input type="text" id="pesoMedio" placeholder="Ex: 0,130">

<label>Quantidade necessária de comprimidos:</label>
<input type="text" id="qtdNecessaria" placeholder="Ex: 100000">

<label>Peso da tara da barrica (kg):</label>
<input type="text" id="taraBarrica" placeholder="Ex: 3,2">

<button type="button" onclick="calcular()">Calcular</button>
<button type="button" class="secondary" onclick="limpar()">Limpar</button>

<div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>

<div id="resultado"></div>

</div>

<script>
/* ========================= FORMATAÇÃO AUTOMÁTICA ========================= */
function aplicarFormatacaoAutomatica(campo, tipo="inteiro") {
    campo.addEventListener("input", function(e) {
        let valor = e.target.value.replace(/\D/g, "");
        if (!valor) { e.target.value=""; return; }
        if(tipo==="inteiro") {
            let numero = parseInt(valor,10);
            e.target.value = numero.toLocaleString("pt-BR");
        }
        if(tipo==="decimal") {
            let numero = parseFloat(valor)/1000;
            e.target.value = numero.toLocaleString("pt-BR",{minimumFractionDigits:3,maximumFractionDigits:3});
        }
    });
}

/* ========================= PARSERS ========================= */
function parseGramas(v){return v?parseFloat(v.replace(/\./g,'').replace(',','.'))/1000:0;}
function parseKg(v){return v?parseFloat(v.replace(/\./g,'').replace(',','.')):0;}
function parseInteiro(v){return v?parseInt(v.replace(/\./g,'').replace(',',''),10):0;}

/* ========================= GERAR BARRICAS ========================= */
function gerarBarricas(){
    let qtd=parseInt(document.getElementById("qtdBarricas").value),div=document.getElementById("barricas");
    div.innerHTML="";
    if(!qtd||qtd<=0)return;
    for(let i=0;i<qtd;i++){
        let container=document.createElement("div");
        let label=document.createElement("label");
        label.textContent=`Barrica ${i+1} – Peso líquido (kg):`;
        let input=document.createElement("input");
        input.type="text"; input.id="b"+i; input.placeholder="Ex: 25,5";
        aplicarFormatacaoAutomatica(input,"decimal");
        container.appendChild(label); container.appendChild(input); div.appendChild(container);
    }
}
aplicarFormatacaoAutomatica(document.getElementById("pesoMedio"),"decimal");
aplicarFormatacaoAutomatica(document.getElementById("qtdNecessaria"),"inteiro");
aplicarFormatacaoAutomatica(document.getElementById("taraBarrica"),"decimal");

/* ========================= CÁLCULO ========================= */
function calcular(){
    let qtd=parseInt(document.getElementById("qtdBarricas").value),
        pesoMedio=parseGramas(document.getElementById("pesoMedio").value),
        necessario=parseInteiro(document.getElementById("qtdNecessaria").value),
        tara=parseKg(document.getElementById("taraBarrica").value),
        resultado=document.getElementById("resultado"),
        progressFill=document.getElementById("progressFill");
    if(!qtd||qtd<=0){resultado.textContent="⚠️ Informe a quantidade de barricas."; return;}
    if(!pesoMedio||pesoMedio<=0){resultado.textContent="⚠️ Peso médio inválido."; return;}
    if(!necessario||necessario<=0){resultado.textContent="⚠️ Quantidade necessária inválida."; return;}
    if(!tara||tara<=0){resultado.textContent="⚠️ Tara inválida."; return;}
    
    let pesos=[],pesoTotalLiquido=0;
    for(let i=0;i<qtd;i++){
        let p=parseKg(document.getElementById("b"+i).value);
        if(!p||p<=0){resultado.textContent=`⚠️ Peso inválido na barrica ${i+1}.`; return;}
        pesos.push(p); pesoTotalLiquido+=p;
    }

    let taraTotal=tara*qtd;
    let pesoTotalBruto=pesoTotalLiquido+taraTotal;
    let comprimidosPossiveis=Math.floor(pesoTotalLiquido/pesoMedio);

    let texto="",perc=Math.min(100,(comprimidosPossiveis/necessario)*100);
    texto+=`Peso total líquido disponível: ${pesoTotalLiquido.toLocaleString("pt-BR")} kg\n`;
    texto+=`Peso total bruto (com tara): ${pesoTotalBruto.toLocaleString("pt-BR")} kg\n`;
    texto+=`Tara total das barricas: ${taraTotal.toLocaleString("pt-BR")} kg\n\n`;
    texto+=`Comprimidos possíveis: ${comprimidosPossiveis.toLocaleString("pt-BR")}\n`;
    texto+=`Comprimidos necessários: ${necessario.toLocaleString("pt-BR")}\n\n`;

    progressFill.style.width=perc+"%";
    progressFill.style.backgroundColor=perc<100?"#b38f00":"#006e4a";

    if(comprimidosPossiveis<necessario){
        texto+="⚠️ Quantidade insuficiente para atender o lote.";
        progressFill.style.backgroundColor="#c00000"; resultado.textContent=texto; return;
    }

    let soma=0,indice=-1;
    for(let j=0;j<pesos.length;j++){soma+=pesos[j]/pesoMedio;if(soma>=necessario){indice=j; break;}}

    let excedenteLocal=soma-necessario;
    let excedenteKg=excedenteLocal*pesoMedio;
    let excedenteUnidades=Math.round(excedenteLocal);

    let pesoOriginal=pesos[indice],pesoQuePermanece=pesoOriginal-excedenteKg;
    if(pesoQuePermanece<0)pesoQuePermanece=0;
    let pesoBrutoOriginal=pesoOriginal+tara;
    let pesoBrutoUtilizado=pesoQuePermanece+tara;

    texto+="⚠️ Excedente identificado. Desmembramento necessário.\n\n";
    texto+=`Barrica utilizada: ${indice+1}\n`;
    texto+=`Peso líquido da barrica: ${pesoOriginal.toLocaleString("pt-BR")} kg\n`;
    texto+=`Peso bruto da barrica: ${pesoBrutoOriginal.toLocaleString("pt-BR")} kg\n\n`;
    texto+=`Quantidade retornando ao stage: ${excedenteKg.toLocaleString("pt-BR")} kg (${excedenteUnidades.toLocaleString("pt-BR")} comprimidos)\n\n`;
    texto+="Quantidade requerida:\n";
    texto+=`  Peso líquido: ${pesoQuePermanece.toLocaleString("pt-BR")} kg\n`;
    texto+=`  Quantidade em unidades: ${Math.round(pesoQuePermanece/pesoMedio).toLocaleString("pt-BR")}\n`;
    texto+=`  Peso bruto: ${pesoBrutoUtilizado.toLocaleString("pt-BR")} kg\n`;

    resultado.textContent=texto;
}

function limpar(){
    document.getElementById("resultado").textContent="";
    document.getElementById("barricas").innerHTML="";
    document.getElementById("progressFill").style.width="0%";
}
</script>
</body>
</html>
