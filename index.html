<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Desmembramento de Granel</title>
<style>
body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 16px; color: #222; }
h1 { text-align: center; color: #006e4a; font-size: 22px; margin-bottom: 16px; }
.container { background: #fff; padding: 16px; border-radius: 12px; max-width: 600px; margin: auto; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
label { display: block; margin-top: 12px; font-size: 14px; }
input { width: 100%; padding: 10px; margin-top: 6px; font-size: 16px; border-radius: 6px; border: 1px solid #bbb; }
button { width: 100%; padding: 12px; margin-top: 16px; font-size: 16px; border-radius: 8px; border: none; background: #006e4a; color: #fff; }
button.secondary { background: #777; }
.barrica { margin-top: 8px; }
#resultado { margin-top: 20px; padding: 14px; background: #e8f5e9; border-left: 5px solid #006e4a; border-radius: 6px; white-space: pre-wrap; font-size: 14px; }
</style>
</head>
<body>

<h1>Desmembramento de Granel</h1>
<div class="container">

<label>Quantidade de barricas:</label>
<input type="number" id="qtdBarricas" min="1">
<button type="button" onclick="gerarBarricas()">Gerar campos</button>
<div id="barricas"></div>

<label>Peso médio do comprimido (g):</label>
<input type="text" id="pesoMedio" placeholder="Ex: 0,130">

<label>Quantidade requerida (unidades):</label>
<input type="text" id="qtdRequerida" placeholder="Ex: 100000">

<label>Peso da tara da barrica (kg):</label>
<input type="text" id="taraBarrica" placeholder="Ex: 3,2">

<button type="button" onclick="calcular()">Calcular</button>
<button type="button" class="secondary" onclick="limpar()">Limpar</button>
<div id="resultado"></div>

</div>

<script>
// Funções de parsing
function parseGramas(v) {
    if (!v) return 0;
    let numero = parseFloat(v.replace(/\./g, '').replace(',', '.'));
    return numero / 1000; // gramas → kg
}
function parseKg(v) {
    if (!v) return 0;
    let numero = parseFloat(v.replace(/\./g, '').replace(',', '.'));
    return numero; // já em kg
}
function parseInteiro(v) {
    if (!v) return 0;
    return parseInt(v.replace(/\./g, '').replace(',', ''), 10);
}

function gerarBarricas() {
    var qtd = parseInt(document.getElementById("qtdBarricas").value, 10);
    var div = document.getElementById("barricas");
    div.innerHTML = "";
    if (!qtd || qtd <= 0) return;

    for (var i = 0; i < qtd; i++) {
        let container = document.createElement("div");
        container.className = "barrica";

        let label = document.createElement("label");
        label.textContent = "Barrica " + (i + 1) + " – Peso bruto (kg):";

        let input = document.createElement("input");
        input.type = "text";
        input.id = "b" + i;
        input.placeholder = "Ex: 25,5";

        container.appendChild(label);
        container.appendChild(input);
        div.appendChild(container);
    }
}

function calcular() {
    var qtd = parseInt(document.getElementById("qtdBarricas").value, 10);
    var pesoMedio = parseGramas(document.getElementById("pesoMedio").value); // kg
    var necessario = parseInteiro(document.getElementById("qtdRequerida").value);
    var tara = parseKg(document.getElementById("taraBarrica").value) || 3.2;
    var resultado = document.getElementById("resultado");

    var pesosBrutos = [];
    var pesoTotalLiquido = 0;
    for (var i = 0; i < qtd; i++) {
        var bruto = parseKg(document.getElementById("b" + i).value);
        var liquido = bruto - tara;
        pesosBrutos.push({bruto, liquido});
        pesoTotalLiquido += liquido;
    }

    var comprimidosPossiveis = Math.floor(pesoTotalLiquido / pesoMedio);

    var texto = "";
    texto += "Peso total líquido disponível: " + pesoTotalLiquido.toLocaleString("pt-BR") + " kg\n";
    texto += "Comprimidos possíveis (unidades): " + comprimidosPossiveis.toLocaleString("pt-BR") + "\n";
    texto += "Comprimidos requeridos: " + (isNaN(necessario) ? 0 : necessario.toLocaleString("pt-BR")) + "\n\n";

    var excedenteTotal = comprimidosPossiveis - necessario;

    if (comprimidosPossiveis < necessario) {
        var falta = necessario - comprimidosPossiveis;
        var perc = (falta / necessario) * 100;
        texto += "⚠️ Quantidade disponível insuficiente. Faltando " + perc.toFixed(2) + "% do lote.\n";
        resultado.textContent = texto;
        return;
    }

    if (excedenteTotal <= 10000) {
        texto += "✅ Quantidade disponível atende ao necessário. Não é preciso desmembrar nenhuma barrica.\n";
        resultado.textContent = texto;
        return;
    }

    // Determinar última barrica usada
    var soma = 0, indice = -1;
    for (var j = 0; j < pesosBrutos.length; j++) {
        soma += pesosBrutos[j].liquido / pesoMedio; // soma em comprimidos
        if (soma >= necessario) { indice = j; break; }
    }

    var excedenteLocal = soma - necessario; // comprimidos
    var pesoExcedenteKg = excedenteLocal * pesoMedio;
    var pesoBruto = pesosBrutos[indice].bruto;
    var pesoLiquido = pesoBrutos[indice].liquido - pesoExcedenteKg;
    if (pesoLiquido < 0) pesoLiquido = 0;
    var excedenteUnidades = Math.round(excedenteLocal);

    texto += "⚠️ Há excedente de comprimidos. Será necessário retirar parte da última barrica utilizada.\n";
    texto += "Barrica utilizada: " + (indice + 1) + "\n";
    texto += "Peso bruto da barrica: " + pesoBruto.toLocaleString("pt-BR") + " kg\n";
    texto += "Tara da barrica: " + tara.toLocaleString("pt-BR") + " kg\n";
    texto += "Quantidade retornando ao stage: " + pesoExcedenteKg.toLocaleString("pt-BR") + " kg (" + excedenteUnidades.toLocaleString("pt-BR") + " unidades)\n";

    var unidadesUtilizadas = Math.round(pesoLiquido / pesoMedio);
    texto += "Quantidade requerida: " + pesoLiquido.toLocaleString("pt-BR") + " kg (" + unidadesUtilizadas.toLocaleString("pt-BR") + " unidades)\n";

    resultado.textContent = texto;
}

function limpar() {
    document.getElementById("resultado").textContent = "";
    document.getElementById("barricas").innerHTML = "";
}
</script>
</body>
</html>
