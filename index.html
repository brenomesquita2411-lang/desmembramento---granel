<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Desmembramento de Granel</title>
<style>
body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 16px; color: #222; }
h1 { text-align: center; color: #006e4a; font-size: 22px; margin-bottom: 16px; }
.container { background: #fff; padding: 16px; border-radius: 12px; max-width: 600px; margin: auto; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
label { display: block; margin-top: 12px; font-size: 14px; }
input { width: 100%; padding: 10px; margin-top: 6px; font-size: 16px; border-radius: 6px; border: 1px solid #bbb; }
button { width: 100%; padding: 12px; margin-top: 16px; font-size: 16px; border-radius: 8px; border: none; background: #006e4a; color: #fff; }
button.secondary { background: #777; }
.barrica { margin-top: 8px; }
#resultado { margin-top: 20px; padding: 14px; background: #e8f5e9; border-left: 5px solid #006e4a; border-radius: 6px; white-space: pre-wrap; font-size: 14px; }
</style>
</head>
<body>

<h1>Desmembramento de Granel</h1>
<div class="container">

<label>Quantidade de barricas:</label>
<input type="number" id="qtdBarricas" min="1">
<button type="button" onclick="gerarBarricas()">Gerar campos</button>
<div id="barricas"></div>

<label>Peso médio do comprimido (g):</label>
<input type="text" id="pesoMedio" placeholder="Ex: 130">

<label>Quantidade necessária de comprimidos:</label>
<input type="text" id="qtdNecessaria" placeholder="Ex: 100000">

<button type="button" onclick="calcular()">Calcular</button>
<button type="button" class="secondary" onclick="limpar()">Limpar</button>
<div id="resultado"></div>

</div>

<script>
// Funções separadas para leitura
function parseGramas(v) {
    if (!v) return 0;
    let numero = parseFloat(v.replace(/\./g, '').replace(',', '.'));
    return numero / 1000; // gramas → kg
}
function parseInteiro(v) {
    if (!v) return 0;
    return parseInt(v.replace(/\./g, '').replace(',', ''), 10);
}

// Função de formatação automática
function aplicarFormatacaoAutomatica(campo, tipo="inteiro") {
    campo.addEventListener("input", function(e) {
        let valor = e.target.value.replace(/\D/g, "");
        if (!valor) {
            e.target.value = "";
            return;
        }
        if (tipo === "inteiro") {
            let numero = parseInt(valor, 10);
            e.target.value = numero.toLocaleString("pt-BR");
        } else if (tipo === "decimal") {
            let numero = parseFloat(valor); // valor em gramas
            numero = numero / 1000; // gramas → kg
            e.target.value = numero.toLocaleString("pt-BR", { minimumFractionDigits: 3, maximumFractionDigits: 3 });
        }
    });
}

function gerarBarricas() {
    var qtd = parseInt(document.getElementById("qtdBarricas").value, 10);
    var div = document.getElementById("barricas");
    div.innerHTML = "";
    if (!qtd || qtd <= 0) return;

    for (var i = 0; i < qtd; i++) {
        let container = document.createElement("div");
        container.className = "barrica";

        let label = document.createElement("label");
        label.textContent = "Barrica " + (i + 1) + " – Peso (kg):";

        let input = document.createElement("input");
        input.type = "text";
        input.id = "b" + i;
        input.placeholder = "Ex: 40500";

        aplicarFormatacaoAutomatica(input, "inteiro");

        container.appendChild(label);
        container.appendChild(input);
        div.appendChild(container);
    }
}

// aplica formatação automática nos campos principais
aplicarFormatacaoAutomatica(document.getElementById("pesoMedio"), "decimal");
aplicarFormatacaoAutomatica(document.getElementById("qtdNecessaria"), "inteiro");

function calcular() {
    var qtd = parseInt(document.getElementById("qtdBarricas").value, 10);
    var pesoMedio = parseGramas(document.getElementById("pesoMedio").value); // agora correto
    var necessario = parseInteiro(document.getElementById("qtdNecessaria").value);
    var resultado = document.getElementById("resultado");

    var pesos = [];
    var pesoTotal = 0;
    for (var i = 0; i < qtd; i++) {
        var p = parseGramas(document.getElementById("b" + i).value);
        pesos.push(p);
        pesoTotal += p;
    }

    var comprimidosPossiveis = Math.floor(pesoTotal / pesoMedio);

    var texto = "";
    texto += "Peso total disponível: " + pesoTotal.toLocaleString("pt-BR") + " kg\n";
    texto += "Comprimidos possíveis: " + (isNaN(comprimidosPossiveis) ? 0 : comprimidosPossiveis.toLocaleString("pt-BR")) + "\n";
    texto += "Comprimidos necessários: " + (isNaN(necessario) ? 0 : necessario.toLocaleString("pt-BR")) + "\n\n";

    var excedenteTotal = comprimidosPossiveis - necessario;

    if (comprimidosPossiveis < necessario) {
        var falta = necessario - comprimidosPossiveis;
        var perc = (falta / necessario) * 100;
        texto += "⚠️ A quantidade disponível não é suficiente. Está faltando " + perc.toLocaleString("pt-BR") + "% do lote.\n";
        resultado.textContent = texto;
        return;
    }

    if (excedenteTotal <= 10000) {
        texto += "✅ A quantidade disponível atende ao necessário. Não é preciso desmembrar nenhuma barrica.\n";
        resultado.textContent = texto;
        return;
    }

    // retirar excedente da última barrica usada
    var soma = 0, indice = -1;
    for (var j = 0; j < pesos.length; j++) {
        soma += pesos[j] / pesoMedio; // soma em comprimidos
        if (soma >= necessario) { indice = j; break; }
    }

    var excedenteLocal = soma - necessario; // excedente em comprimidos
    var excedenteKg = excedenteLocal * pesoMedio; // converte excedente para kg
    var pesoOriginal = pesos[indice];
    var pesoQuePermanece = pesoOriginal - excedenteKg;
    if (pesoQuePermanece < 0) pesoQuePermanece = 0;

    texto += "⚠️ Há excedente de comprimidos. Será necessário retirar parte da última barrica utilizada.\n";
    texto += "Barrica utilizada: " + (indice + 1) + "\n";
    texto += "Peso original da barrica: " + pesoOriginal.toLocaleString("pt-BR") + " kg\n";
    texto += "Quantidade retornando ao stage: " + excedenteKg.toLocaleString("pt-BR") + " kg\n";
    texto += "Quantidade utilizada em sala: " + pesoQuePermanece.toLocaleString("pt-BR") + " kg\n";

    resultado.textContent = texto;
}

function limpar() {
    document.getElementById("resultado").textContent = "";
    document.getElementById("barricas").innerHTML = "";
}
</script>
</body>
</html>
